@echo off
chcp 65001
cls
echo ================================================================
echo           ESP32-C5 çƒ§å½•é—®é¢˜è‡ªåŠ¨ä¿®å¤å·¥å…·
echo ================================================================
echo.

echo ðŸ” æ­¥éª¤1: æ£€æŸ¥ä¸²å£çŠ¶æ€...
echo ----------------------------------------------------------------
powershell -Command "Get-WmiObject -Class Win32_SerialPort | Select-Object DeviceID, Name, Status" 2>nul
if %errorlevel% neq 0 (
    echo âŒ æ— æ³•æ£€æŸ¥ä¸²å£çŠ¶æ€ï¼Œå¯èƒ½æƒé™ä¸è¶³
) else (
    echo âœ… ä¸²å£çŠ¶æ€æ£€æŸ¥å®Œæˆ
)
echo.

echo ðŸ›‘ æ­¥éª¤2: å…³é—­å¯èƒ½å ç”¨ä¸²å£çš„ç¨‹åº...
echo ----------------------------------------------------------------
echo æ­£åœ¨å°è¯•å…³é—­å¯èƒ½å ç”¨ä¸²å£çš„è¿›ç¨‹...
taskkill /f /im "monitor.exe" 2>nul
taskkill /f /im "putty.exe" 2>nul
taskkill /f /im "arduino.exe" 2>nul
taskkill /f /im "idf_monitor.exe" 2>nul
taskkill /f /im "minicom.exe" 2>nul
echo âœ… è¿›ç¨‹æ¸…ç†å®Œæˆ
echo.

echo â³ æ­¥éª¤3: ç­‰å¾…ä¸²å£é‡Šæ”¾...
echo ----------------------------------------------------------------
timeout /t 3 /nobreak >nul
echo âœ… ç­‰å¾…å®Œæˆ
echo.

echo ðŸ”§ æ­¥éª¤4: å°è¯•ä¸åŒçš„çƒ§å½•æ–¹å¼...
echo ================================================================
echo.

echo ðŸ“‹ è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œESP32-C5å¼€å‘æ¿ï¼š
echo ----------------------------------------------------------------
echo  1ï¸âƒ£  æŒ‰ä½ BOOT æŒ‰é’®ï¼ˆä¸è¦æ¾å¼€ï¼‰
echo  2ï¸âƒ£  çŸ­æŒ‰ä¸€ä¸‹ RESET æŒ‰é’®ï¼Œç„¶åŽç«‹å³æ¾å¼€
echo  3ï¸âƒ£  ç»§ç»­æŒ‰ä½ BOOT æŒ‰é’® 2-3 ç§’
echo  4ï¸âƒ£  æ¾å¼€ BOOT æŒ‰é’®
echo  5ï¸âƒ£  æŒ‰ä»»æ„é”®ç»§ç»­çƒ§å½•...
echo ----------------------------------------------------------------
pause >nul
echo.

echo ðŸš€ å¼€å§‹çƒ§å½• - æ–¹æ³•1: ä½Žæ³¢ç‰¹çŽ‡çƒ§å½•
echo ----------------------------------------------------------------
idf.py -p COM4 -b 115200 flash
if %errorlevel% equ 0 (
    echo âœ… çƒ§å½•æˆåŠŸï¼
    goto :success
)
echo âŒ æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2...
echo.

echo ðŸš€ å¼€å§‹çƒ§å½• - æ–¹æ³•2: ä½¿ç”¨no-stubé€‰é¡¹
echo ----------------------------------------------------------------
echo ðŸ“‹ è¯·é‡æ–°è¿›å…¥ä¸‹è½½æ¨¡å¼ï¼ˆé‡å¤ä¸Šè¿°æŒ‰é’®æ“ä½œï¼‰ï¼Œç„¶åŽæŒ‰ä»»æ„é”®ç»§ç»­...
pause >nul
idf.py -p COM4 --no-stub flash
if %errorlevel% equ 0 (
    echo âœ… çƒ§å½•æˆåŠŸï¼
    goto :success
)
echo âŒ æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3...
echo.

echo ðŸš€ å¼€å§‹çƒ§å½• - æ–¹æ³•3: æŒ‡å®šèŠ¯ç‰‡ç±»åž‹
echo ----------------------------------------------------------------
echo ðŸ“‹ è¯·é‡æ–°è¿›å…¥ä¸‹è½½æ¨¡å¼ï¼ˆé‡å¤ä¸Šè¿°æŒ‰é’®æ“ä½œï¼‰ï¼Œç„¶åŽæŒ‰ä»»æ„é”®ç»§ç»­...
pause >nul
idf.py -p COM4 --chip esp32c5 -b 115200 flash
if %errorlevel% equ 0 (
    echo âœ… çƒ§å½•æˆåŠŸï¼
    goto :success
)
echo âŒ æ–¹æ³•3å¤±è´¥ï¼Œå°è¯•æ–¹æ³•4...
echo.

echo ðŸš€ å¼€å§‹çƒ§å½• - æ–¹æ³•4: ä½¿ç”¨esptoolç›´æŽ¥çƒ§å½•
echo ----------------------------------------------------------------
echo ðŸ“‹ è¯·é‡æ–°è¿›å…¥ä¸‹è½½æ¨¡å¼ï¼ˆé‡å¤ä¸Šè¿°æŒ‰é’®æ“ä½œï¼‰ï¼Œç„¶åŽæŒ‰ä»»æ„é”®ç»§ç»­...
pause >nul
if exist "build\bootloader\bootloader.bin" (
    python -m esptool --chip esp32c5 --port COM4 --baud 115200 write_flash 0x0 build\bootloader\bootloader.bin 0x8000 build\partition_table\partition-table.bin 0x10000 build\wifi_station.bin
    if %errorlevel% equ 0 (
        echo âœ… çƒ§å½•æˆåŠŸï¼
        goto :success
    )
)
echo âŒ æ‰€æœ‰è‡ªåŠ¨æ–¹æ³•éƒ½å¤±è´¥äº†
echo.

echo ðŸ’¡ æ‰‹åŠ¨è§£å†³å»ºè®®ï¼š
echo ================================================================
echo  ðŸ”§ 1. æ£€æŸ¥USBçº¿ç¼†æ˜¯å¦ä¸ºæ•°æ®çº¿ï¼ˆä¸æ˜¯å……ç”µçº¿ï¼‰
echo  ðŸ”§ 2. å°è¯•æ›´æ¢USBç«¯å£
echo  ðŸ”§ 3. æ£€æŸ¥è®¾å¤‡ç®¡ç†å™¨ä¸­çš„é©±åŠ¨ç¨‹åº
echo  ðŸ”§ 4. å°è¯•ä½¿ç”¨å›¾å½¢åŒ–çƒ§å½•å·¥å…·
echo  ðŸ”§ 5. è”ç³»å¼€å‘æ¿ä¾›åº”å•†æˆ–æŸ¥çœ‹ç¡¬ä»¶æ–‡æ¡£
echo.
echo ðŸ“– è¯¦ç»†æ•…éšœæŽ’é™¤æŒ‡å—ï¼šESP32C5_ä¸²å£é—®é¢˜è§£å†³æŒ‡å—.md
goto :end

:success
echo.
echo ðŸŽ‰ çƒ§å½•æˆåŠŸå®Œæˆï¼
echo ================================================================
echo  âœ… å›ºä»¶å·²æˆåŠŸçƒ§å½•åˆ°ESP32-C5
echo  ðŸ” æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¾“å‡ºï¼š
echo     idf.py -p COM4 monitor
echo.

:end
echo æŒ‰ä»»æ„é”®é€€å‡º...
pause >nul 